# Claude Code Plus - Project Guide

This file helps Claude Code understand the project structure and development workflow.

## Project Overview

Claude Code Plus is an installer that enhances Claude Code CLI. It addresses two main issues:

1. **Piped commands not auto-approved** ([#13340](https://github.com/anthropics/claude-code/issues/13340)) - Addressed via a PreToolUse hook
2. **Custom shell not respected** ([#7490](https://github.com/anthropics/claude-code/issues/7490)) - Addressed via settings.json env config + shell alias workaround

## Project Structure

```
claude-code-plus/
├── package.json          # npm package config (name: claude-code-plus)
├── tsconfig.json         # TypeScript configuration
├── eslint.config.js      # ESLint flat config
├── jest.config.cjs       # Jest configuration
├── README.md             # User documentation
├── CLAUDE.md             # This file
├── assets/
│   └── auto-approve-allowed-commands.sh  # Hook script (copied at install time)
├── src/
│   ├── cli.ts            # Main entry point, arg parsing, install flow
│   ├── prompts.ts        # Interactive prompts with TTY detection
│   ├── settings.ts       # Claude settings.json manipulation
│   ├── hooks.ts          # Hook file generation
│   ├── shell-alias.ts    # Shell config modification for bash/zsh/fish
│   ├── permissions.ts    # Default safe Bash permissions list (850+)
│   ├── *.test.ts         # Jest tests (co-located with source)
│   └── utils/
│       ├── colors.ts     # Terminal output helpers (info, success, error, etc.)
│       ├── exec.ts       # Shell command execution helpers
│       └── chezmoi.ts    # Chezmoi detection and path resolution
├── dist/                 # Compiled JavaScript (generated by tsc)
└── test/
    └── hook/             # Bats tests for the hook script
```

## Development Workflow

### Building

```bash
# Install dependencies
npm install

# Build TypeScript
npm run build

# Run linter
npm run lint
npm run lint:fix

# Run the installer locally
node dist/cli.js
node dist/cli.js -y
node dist/cli.js --help
```

### Testing

This project uses Jest with ts-jest for testing. Tests follow the **Arrange-Act-Assert (AAA)** pattern with `createTestContext()` functions at the bottom of describe blocks for shared test fixtures.

#### Running Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage
npm run test:coverage
```

#### Test Pattern

Tests use explicit AAA comments and a `createTestContext()` pattern for shared setup:

```typescript
describe('feature', function() {
  it('does something specific', function() {
    // Arrange
    const { Model } = createTestContext();
    const input = 'test-input';

    // Act
    const result = Model.doSomething(input);

    // Assert
    expect(result).toBe('expected-output');
  });

  function createTestContext() {
    // Shared test setup at the bottom of describe block
    const Model = createModel();
    return { Model };
  }
});
```

#### Manual Testing

**IMPORTANT:** Always test against a `/tmp/` directory, never against the real `~/.claude`. This prevents accidentally corrupting your actual Claude Code configuration.

```bash
# Test with custom directory (ALWAYS use /tmp for testing)
CLAUDE_DIR_OVERRIDE=/tmp/test-claude node dist/cli.js -y

# Interactive test
CLAUDE_DIR_OVERRIDE=/tmp/test-claude node dist/cli.js

# Clean up after testing
rm -rf /tmp/test-claude
```

### Adding New Permissions

Edit `src/permissions.ts` and add entries to the `DEFAULT_PERMISSIONS` array:

```typescript
export const DEFAULT_PERMISSIONS: string[] = [
  // ... existing permissions ...
  'Bash(new-command:*)',
];
```

Then rebuild with `npm run build`.

## Key Design Decisions

1. **TypeScript + npx distribution**: Easy cross-platform installation via `npx claude-code-plus`
2. **Interactive by default**: Users choose "Recommended" or "Custom" installation mode
3. **Non-interactive mode**: `-y` flag for scripting/automation
4. **Cross-platform bash detection**: Finds modern bash dynamically (Homebrew paths on macOS, /bin/bash on Linux)
5. **Auto-detect chezmoi**: Automatically detects if `~/.claude` is managed by chezmoi and adjusts paths/prefixes accordingly
6. **Shell alias workaround**: Adds `claude` function to shell configs that sets `SHELL` env var (workaround until this is addressed upstream)

### CLI Flags

- `--yes, -y` - Non-interactive mode, accept all defaults
- `--help, -h` - Show help message

## Key Implementation Details

### Platform Detection (`src/cli.ts`)

- Uses `process.platform === 'darwin'` to detect macOS
- macOS: checks Homebrew paths first (`/opt/homebrew/bin/bash`, `/usr/local/bin/bash`)
- Linux: checks `/bin/bash` first (usually modern)
- Install hints are platform-aware (brew vs apt/dnf/pacman)

### Chezmoi Integration (`src/utils/chezmoi.ts`)

The installer auto-detects chezmoi:
- Checks if `chezmoi source-path ~/.claude` succeeds
- If managed: writes to chezmoi source dir, uses `executable_` prefix for hooks
- Tracks modified files and prompts to run `chezmoi apply` at the end
- Skips chezmoi logic when `CLAUDE_DIR_OVERRIDE` is set (for testing)

### Shell Alias Workaround (`src/shell-alias.ts`)

Until Claude Code addresses issue #7490, we add a shell function/alias:
- Bash/Zsh: `claude() { SHELL=/path/to/bash command claude "$@"; }`
- Fish: `function claude; SHELL=/path/to/bash command claude $argv; end`
- Added to all existing shell config files (.bashrc, .bash_profile, .zshrc, config.fish)
- Marked with `# Added by claude-code-plus for shell alias` for identification

### Hook Configuration (`src/hooks.ts`, `src/settings.ts`)

The hook is added to settings.json under `.hooks.PreToolUse`:
- Merges with existing hooks (doesn't overwrite)
- Uses `$HOME/.claude/hooks/...` path (expanded at runtime by Claude Code)
- Checks for existing hook before adding

## Dependencies

**Runtime:**
- Node.js 18+ (for npx)
- bash 4.4+ (checked at runtime, install hints provided if missing)
- jq (checked at runtime, install hints provided if missing)
- shfmt (checked at runtime, install hints provided if missing)

The installer checks for these dependencies and provides platform-specific install hints if any are missing.

**Dev dependencies:**
- TypeScript
- ESLint with typescript-eslint
- Jest with ts-jest (for testing)

## Code Migration Workflows

These workflows help you review changes more easily by leveraging git diffs.

### File Migration Workflow
**When moving code from one file to another, NEVER rewrite the code manually. Use `cp` command first, then modify.**

#### The Problem
When an LLM moves code from file A to file B by rewriting it, the user must review line-by-line to verify no unintended changes were made. This is time-consuming and error-prone because the entire file appears as "new" in git diff.

#### The Solution
Use a two-step workflow that leverages git as a verification tool:

**Step 1: Copy the file**
```bash
cp src/old-location/file.ts src/new-location/file.ts
```

**Step 2: Prompt user to stage so you can continue**
- Stop and inform the user the file has been copied
- Ask the user to stage the copied file with `git add` and let you know when to continue
- User verifies the copy is identical (git will show it as a new file with original content)
- User says "continue"

**Step 3: Modify the copied file**
- Now modify the new file to achieve the desired changes
- Git diff will show ONLY the modifications, not a complete rewrite
- User only needs to review the actual changes

### Code Snippet Migration Workflow
**When extracting/moving code snippets (>15 lines), NEVER manually copy the code. Use CLI tools for mechanical extraction.**

**Step 1: Extract using CLI tools**
```bash
# Append to end of existing file
sed -n '45,95p' src/old-file.ts >> src/target-file.ts

# Create brand new file with extracted code
sed -n '45,95p' src/old-file.ts > src/new-file.ts
```

**Step 2: Prompt user to stage so you can continue**
- Stop and inform the user the code has been extracted
- Ask the user to stage the changes with `git add` and let you know when to continue

**Step 3: Modify the extracted code**
- Now modify the extracted code (wrap in function, remove unwanted bits, etc.)
- Git diff shows only the actual modifications

#### When to Use These Approaches
- Moving code from one file to another
- Extracting functions (>15 lines)
- Refactoring large chunks of code
- Any code movement where verification is important

#### When NOT to Use These Approaches
- Writing completely new code (nothing to copy)
- Small extractions (<15 lines) - just use Edit tool
- Making small edits to existing files (use Edit tool)

## Related Issues

- [#13340](https://github.com/anthropics/claude-code/issues/13340) - Piped commands permission limitation
- [#7490](https://github.com/anthropics/claude-code/issues/7490) - Custom shell not respected
